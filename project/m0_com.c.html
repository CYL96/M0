<p>/<strong><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em></strong></p>

<blockquote>
  <p>File Name: m0_com.c
Author:LCY 
Mail: 
Created Time: Mon 19 Mar 2018 08:42:22 PM CST
 <strong><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em>**</strong>/</p>
</blockquote>

<h1>include<stdio.h></h1>

<h1>include<string.h></h1>

<h1>include<stdlib.h></h1>

<h1>include<strings.h></h1>

<h1>include<pthread.h></h1>

<h1>include"m0.c"</h1>

<h1>include"m0_struct.c"</h1>

<p>hum<em>t hum;
tem</em>t tem;
uint8<em>t idd;
char cmd='0';
char lcmd='0';
void *m0</em>recv_data(void *arg)
{</p>

<pre><code>int len=0,num=0;
int fd=(int)arg;
printf("recv from fd:%d\n",fd);
uint8_t recvbuf[36];
uint8_t *p;
int err=0;
struct pollfd pfd=
{
.fd=fd,
.events=POLLIN,
.revents=0,
};
while(1)
{

    memset(recvbuf,0,36);
    p=recvbuf;
    num=m0_recv(fd,p,1,1000);
    if(num&lt;0)
    {
        printf("recv filed!\n");
        err++;
        continue;
    }
    if(p[0] != 0XBB)
    {
        printf("  ");
        continue;
    }
    p++;
    len=35;
    while(len)
    {
        num = m0_recv(fd, p, len, -1);
        if(0 &gt; num)
        {
            printf("recv fail.\n");
            return ;
        }
        len -=num;
        p+=num;
    }
    printf("recv:");
    int i;
    for(i = 0; i &lt; 36; i++){
        printf("%.2X ", recvbuf[i]);
    }
    printf("\n");
    tem.ltem=recvbuf[4];
    tem.htem=recvbuf[5];
    hum.lhum=recvbuf[6];
    hum.hhum=recvbuf[7];
    idd=recvbuf[1];
}
</code></pre>

<p>return 0;
}
int led<em>on(int fd,char recvbuf[36])
{
    recvbuf[4] =0x01;
    m0</em>send(fd,recvbuf,36,-1);
    return 0;</p>

<p>}
int led<em>off(int fd,char recvbuf[36])
{
    recvbuf[4]= 0x00;
    m0</em>send(fd,recvbuf,36,-1);
    return 0;
}
int fan<em>on(int fd,char recvbuf[36])
{
    recvbuf[4] = 0x04;
    m0</em>send(fd,recvbuf,36,-1);
    return 0;
}
int fan<em>off(int fd,char recvbuf[36])
{
    recvbuf[4] = 0x08;
    m0</em>send(fd,recvbuf,36,-1);
    return 0;
}
int buz<em>on(int fd,char recvbuf[36])
{
    recvbuf[4] =0x02;
    m0</em>send(fd,recvbuf,36,-1);
    return 0;
}
int buz<em>off(int fd,char recvbuf[36])
{
    recvbuf[4] =0x03;
    m0</em>send(fd,recvbuf,36,-1);
    return 0;
}
int all<em>off(int fd,char recvbuf[36])
{
    led</em>off(fd,recvbuf);
    fan<em>off(fd,recvbuf);
    buz</em>off(fd,recvbuf);
    return 0;
}
void m0<em>send</em>data(int fd)
{
    uint8<em>t sendbuf[36];
    //   char cmd,lcmd;
    int i=0;
    memset(sendbuf,0,36);
    sendbuf[0]=0XDD;
    sendbuf[1]=idd;
    sendbuf[2]=0x24;
    sendbuf[3]=0x00;
    switch(cmd)
    {
        case 'a':led</em>on(fd,sendbuf);break;
        case 'b':led<em>off(fd,sendbuf);break;
        case 'c':fan</em>on(fd,sendbuf);break;
        case 'd':fan<em>off(fd,sendbuf);break;
        case 'e':buz</em>on(fd,sendbuf);break;
        case 'f':buz<em>off(fd,sendbuf);break;
        case 'g':all</em>off(fd,sendbuf);break;
        default:break;
    }
    printf("send:");
    for(i=0;i&lt;36;i++)
    {
        printf("%.2x ",sendbuf[i]);
    }
    printf("\n");</p>

<p>}
int main(int arg,char *argv[])
{
    int fd= m0<em>init(0);
    if(fd&lt;0)
    {
        perror("Serial Init Error");
        return -1;
    }
    pthread</em>t tid[2];
    pthread<em>create(&amp;tid[0],NULL,m0</em>recv<em>data,(void *)fd);
    while(1)
    {
        scanf("%c",&amp;cmd);
        printf("%c22222222222\n",c);
        if(cmd!=lcmd)
        {
            printf("1111111111111\n");
            m0</em>send_data(fd);
            lcmd=cmd;
        }
    }</p>

<p>}</p>
